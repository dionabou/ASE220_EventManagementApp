<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendee Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<button id="sidebarToggle" class="sidebar-toggle">
   <i class="fa-solid fa-heart"></i>
</button>
 
<div id="favoritesSidebar" class="sidebar-wrapper">
   <div class="sidebar-header">
     <h3><i class="fa-solid fa-heart favorite-icon"></i> My Favorites</h3>
     <button id="closeSidebar" class="btn-close btn-close-white"></button>
   </div>
   <div class="sidebar-content">
     <div id="sidebarFavoritesList">
       <!-- Favorites will be listed here -->
     </div>
     <div class="mt-3">
       <a href="favorites.html" class="btn btn-outline-primary w-100">View All Favorites</a>
     </div>
   </div>
 </div>

  <div class="container my-4 ">
    <h1 class="text-center mb-4">Browse Events</h1>

    <div id="notification" class="notification"></div>

    <div class="mb-3">
        <input type="text" id="searchBar" class="form-control" placeholder="Search for events...">
    </div>
  
    <div class="row row-cols-1 row-cols-md-3 g-4" id="event-container"></div>

    <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="eventModalBody"></div>
            </div>
        </div>
    </div>
  </div>

  <!-- Modal to show event details -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="detailsModal">Event Details</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="row">
                <img id="details-image" src="">
            </div>
            <hr>
            <div class="row p-2 justify-content-between">
                <div class="col">
                    <h1 id="detailsEventName">Event Title</h1>
                </div>
                <div class="col-2"></div>
                <div class="col-3">
                    <p id="detailsPrice" class="fs-5">Price</p>
                </div>
            </div>
            <hr>
            <div class="row p-2 justify-content-between">
                <div class="col">
                    <h3 id="detailsLocation" class="text-secondary-emphasis">Location:</h3>
                </div>
                <div class="col-3">
                    <h5 id="detailsCapacity" class="text-secondary-emphasis">Capacity:</h5>
                </div>
            </div>
            <div class="row">
                <p id="detailsDescription" class="text-secondary fs-5">Event Description</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary register-event" data-id="${event.id}">Register</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Define initFavoritesSidebar function here
    function initFavoritesSidebar() {
      const sidebarToggle = document.getElementById('sidebarToggle');
      const closeSidebar = document.getElementById('closeSidebar');
      const favoritesSidebar = document.getElementById('favoritesSidebar');
      const sidebarFavoritesList = document.getElementById('sidebarFavoritesList');
    
      // Toggle sidebar
      sidebarToggle.addEventListener('click', () => {
        favoritesSidebar.classList.add('active');
        updateSidebarFavorites();
      });
    
      // Close sidebar
      closeSidebar.addEventListener('click', () => {
        favoritesSidebar.classList.remove('active');
      });
    
      // Update sidebar favorites list
      function updateSidebarFavorites() {
        // Get favorite events
        const favorites = JSON.parse(localStorage.getItem('favorites')) || {};
        const favoriteEventIds = Object.keys(favorites).filter(id => favorites[id]);
        
        if (favoriteEventIds.length === 0) {
          sidebarFavoritesList.innerHTML = `
            <div class="text-center p-3">
              <p>No favorite events yet.</p>
            </div>
          `;
          return;
        }
        
        // Filter events to only include favorites
        const favoriteEvents = events.filter(event => favorites[event.id]);
        
        // Render sidebar list (show maximum 5 events)
        const eventsToShow = favoriteEvents.slice(0, 5);
        const hasMore = favoriteEvents.length > 5;
        
        sidebarFavoritesList.innerHTML = eventsToShow.map(event => `
          <div class="sidebar-item">
            <div class="d-flex align-items-center">
              <i class="fa-solid fa-heart favorite-icon"></i>
              <a href="#" class="sidebar-event-link" data-id="${event.id}">${event.name}</a>
            </div>
          </div>
        `).join('');
        
        if (hasMore) {
          sidebarFavoritesList.innerHTML += `
            <div class="text-center mt-2">
              <small class="text-muted">+ ${favoriteEvents.length - 5} more favorites</small>
            </div>
          `;
        }
        
        // Add event listeners to sidebar items
        document.querySelectorAll('.sidebar-event-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const eventId = parseInt(e.target.getAttribute('data-id'));
            setDetailModal(eventId);
            favoritesSidebar.classList.remove('active');
          });
        });
      }
    
      // Update sidebar when favorites change
      document.addEventListener('favoritesUpdated', updateSidebarFavorites);
    }

    const storage_url = "https://jsonblob.com/api/1345098910003290112";
    var events = [];
    let favoriteEvents = JSON.parse(localStorage.getItem("favorites")) || {};
    let eventRatings = JSON.parse(localStorage.getItem("ratings")) || {};

    let eventContainer = document.getElementById("event-container");
    let searchBar = document.getElementById("searchBar");
    let notification = document.getElementById("notification");

    async function fetchEvents() {
        try {
            const response = await fetch(storage_url);
            let data = await response.json();
            events = data.filter(item => item.id && item.name && item.image);
            renderEvents();
        } catch (error) {
            console.error("Error fetching events:", error);
        }
    }

    function renderEvents(filter = "") {
        eventContainer.innerHTML = events
            .filter(event => event.name.toLowerCase().includes(filter.toLowerCase()))
            .map(createEventCard)
            .join("");
    }

    function createEventCard(event) {
        const isFavorite = favoriteEvents[event.id] ? "active" : "";
        return `
            <div class="col-md-4 mb-4">
                <div class="card">
                    <img src="${event.image}" class="card-img-top event-img" alt="${event.name}">
                    <div class="card-body">
                        <h4 class="card-title">${event.name}</h4>
                        <p><strong>Date:</strong> ${event.date}</p>
                        <p><strong>Location:</strong> ${event.location}</p>
                        <button class="btn btn-info view-details" data-id="${event.id}" id="${event.id}" onclick='setDetailModal(this.id)'>View Details</button>
                        <button class="btn btn-primary register-event" data-id="${event.id}">Register</button>
                        <i class="fa-regular fa-heart favorite ${isFavorite}" data-id="${event.id}"></i>
                        <i class="fa-solid fa-share-nodes share" data-id="${event.id}" title="Share this event"></i>
                    </div>
                </div>
            </div>
        `;
    }

    function showNotification(message) {
        notification.textContent = message;
        notification.style.display = "block";
        setTimeout(() => {
            notification.style.display = "none";
        }, 5000);
    }

    eventContainer.addEventListener("click", (e) => {
        if (e.target.classList.contains("favorite")) {
            const eventId = parseInt(e.target.getAttribute("data-id"));
            if (!favoriteEvents[eventId]) {
                favoriteEvents[eventId] = true;
                e.target.classList.add("active");
                e.target.classList.replace("fa-regular", "fa-solid");
                showNotification("Event added to favorites");
            } else {
                delete favoriteEvents[eventId];
                e.target.classList.remove("active");
                e.target.classList.replace("fa-solid", "fa-regular");
                showNotification("Event removed from favorites");
            }
            localStorage.setItem("favorites", JSON.stringify(favoriteEvents));
        }

        if (e.target.classList.contains("share")) {
            const eventId = parseInt(e.target.getAttribute("data-id"));
            const event = events.find(ev => ev.id === eventId);
            navigator.clipboard.writeText(`${window.location.href}?event=${event.id}`)
                .then(() => showNotification("Event link copied"))
                .catch(err => console.error("Failed to copy", err));
        }
    });

    searchBar.addEventListener("keyup", () => {
        renderEvents(searchBar.value);
    });
    
    fetchEvents().then(() => {
      initFavoritesSidebar();  // Initialize the sidebar after the events are fetched
    });

    // Shows the event detail modal
    function showDetailModal(){
        var modal = new bootstrap.Modal(document.getElementById('detailsModal'));
        modal.show();
    }

    // Gets JSON data for use in the modal
    async function getDetailData() {
        try {
            const response = await fetch(storage_url);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching or parsing data:', error);
            return null;
        }
    }

    // Sets modal text to JSON data
    async function setDetailModal(buttonId){
        const eventId = Number(buttonId); 
        var detailData = await getDetailData();
        if (!detailData) {
            console.error("Failed to fetch data.");
            return;
        }
        const event = detailData.find(item => item.id === eventId);
        if (event) {
            document.getElementById('detailsEventName').innerHTML = `${event.name}`;
            document.getElementById('detailsLocation').innerHTML = `${event.location}`;
            document.getElementById('detailsDescription').innerHTML = `${event.description}`;
            document.getElementById('details-image').src = `${event.image}`;
            document.getElementById('detailsPrice').innerHTML = `Entry Price:<br><span class="fs-3">$${event.price}</span>`;
            document.getElementById('detailsCapacity').innerHTML = `Capacity: ${event.capacity}`;
        } else {
            console.log("Event not found");
        }

        // Show modal
        showDetailModal();
    }
  </script>
</body>
</html>
